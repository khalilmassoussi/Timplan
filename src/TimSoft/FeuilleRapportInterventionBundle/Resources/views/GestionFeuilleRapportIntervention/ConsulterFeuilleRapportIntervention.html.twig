{% extends 'Squelette.html.twig' %}

{% block Titre %}
    Portail web de TimSoft - Les feuilles de présence & Rapport d'intervention
{% endblock %}

{% block Section %}
    <h1>
        Feuille de présence & Rapport d'intervention
        <small>Consultation</small>
    </h1>
{% endblock %}

{% block Navigation %}
    <li class="breadcrumb-item active">Consultation</li>
{% endblock %}
{% block SideBar %}
{% endblock %}

{% block Contenu %}

    {% for message in app.flashes('OK-Suppression') %}
        <div class="flash-notice">
            <body onLoad="$('#my-modal').modal('show');">
            <div id="my-modal" class="modal fade">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title">Validation de suppression</h4>
                        </div>
                        <div class="modal-body">
                            {{ message }}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
                        </div>
                    </div>
                </div>
            </div>
            </body>
        </div>
    {% endfor %}
    {% for message in app.flashes('RapportValide') %}
        <div class="flash-notice">
            <body onLoad="$('#my-modal').modal('show');">
            <div id="my-modal" class="modal fade">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title">Erreur de modification</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        </div>
                        <div class="modal-body">
                            {{ message }}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
                        </div>
                    </div>
                </div>
            </div>
            </body>
        </div>
    {% endfor %}
    {% for message in app.flashes('FeuilleValide') %}
        <div class="flash-notice">
            <body onLoad="$('#my-modal').modal('show');">
            <div id="my-modal" class="modal fade">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title">Erreur de modification</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        </div>
                        <div class="modal-body">
                            {{ message }}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
                        </div>
                    </div>
                </div>
            </div>
            </body>
        </div>
    {% endfor %}
    <div class="col-md-12">
        <div class="card">
            {#            <div class="card-header with-border">#}
            {#                <h2 class="card-title" style="color:#1E5584">La liste des feuilles de présence & rapport#}
            {#                    d'intervention</h2>#}
            {#            </div>#}
            <div class="card-body">
                {% if AutorisationAcces('RemplirFeuillePresence' , Utilisateur) %}
                    <div style="display: inline">
                        <a href="{{ path('GetMyPlans') }}" class="btn btn-default" style="margin-left: 0px;">
                            <i class="fa fa-plus-square-o"></i>
                            Rédiger une feuille de présence & rapport d'intervention </a>
                        <div align="right">
                            <div class="input-group" style="width: 19%;">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fa fa-calendar"></i></span>
                                </div>
                                <input type="text" name="daterange" class="daterange form-control"
                                       placeholder="Filtre par date"/>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <table id="TableRIFP" class="table table-bordered table-striped dataTable" style="width: 100%">
                    <thead>
                    <tr>
                        <th>Id</th>
                        <th id="Date">Date
                        </th>
                        <th>Client
                        </th>
                        <th>Intervenant
                        </th>
                        <th>Type
                        </th>
                        <th>Validation
                        </th>
                        <th>
                            <center> Action</center>
                        </th>
                    </tr>
                    </thead>
                    {#                    <tbody>#}
                    {#                    {% if (Feuilles is defined) %}#}
                    {#                        {% for Feuille in Feuilles %}#}
                    {#                            {% if Feuille.statutValidation %}#}
                    {#                                <tr class="row1" style="color: green; font-weight:bold">#}
                    {#                            {% else %}#}
                    {#                                <tr class="row1">#}
                    {#                            {% endif %}#}
                    {#                            <td>#}
                    {#                                {{ Feuille.dateIntervention|date('d-m-Y') }}#}
                    {#                            </td>#}
                    {#                            <td>#}
                    {#                                {{ Feuille.client }}#}
                    {#                            </td>#}
                    {#                            <td>#}
                    {#                                {{ Feuille.intervenant.nomUtilisateur }} {{ Feuille.intervenant.prenomUtilisateur }}#}
                    {#                            </td>#}
                    {#                            <td>#}
                    {#                                Feuille de présence#}
                    {#                            </td>#}
                    {#                            <td>#}
                    {#                                {% if  Feuille.statutValidation %}#}
                    {#                                    Validé#}
                    {#                                {% else %}#}
                    {#                                    Non Validé#}
                    {#                                {% endif %}#}
                    {#                            </td>#}
                    {#                            <td>#}
                    {#                                <center>#}
                    {#                                    {% if Feuille.statutValidation %}#}
                    {#                                        {% if AutorisationAcces('ConsulterFeuillePresence' , Utilisateur) %}#}
                    {#                                            <a href="{{ path('ConsulterFeuillePresence', { 'id': Feuille.id }) }}">#}
                    {#                                                <i class="fas fa-search fa-lg"#}
                    {#                                                   title="Consulter la feuille de présence"></i>#}
                    {#                                            </a>#}
                    {#                                        {% endif %}#}
                    {#                                    {% endif %}#}
                    {#                                    {% if not (Feuille.statutValidation) %}#}
                    {#                                        {% if AutorisationAcces('ModifierFeuillePresence' , Utilisateur) %}#}
                    {#                                            <a href="{{ path('ModifierFeuillePresence', { 'id': Feuille.id }) }}">#}
                    {#                                                <i class="fas fa-edit fa-lg" title="Modifier la feuille de présnce"></i>#}
                    {#                                            </a>#}
                    {#                                        {% endif %}#}
                    {#                                        {% if AutorisationAcces('SupprimerUneFeuille' , Utilisateur) %}#}
                    {#                                            <a href="{{ path('SupprimerUneFeuille', { 'id': Feuille.id }) }}">#}
                    {#                                                <i class="fas fa-trash fa-lg"#}
                    {#                                                   title="Supprimer la feuille de présence"></i>#}
                    {#                                            </a>#}
                    {#                                        {% endif %}#}
                    {#                                    {% else %}#}
                    {#                                        #}{#<img src="{{ asset('Template/Editer.png') }}"#}
                    {#                                        #}{#title="La feuille ne peut pas être modifiée">#}
                    {#                                        #}{#<img src="{{ asset('Template/SupprimerUser.png') }}"#}
                    {#                                        #}{#title="La feuille ne peut pas être supprimée">#}
                    {#                                    {% endif %}#}
                    {#                                    {% if AutorisationAcces('TelechargerFeuillePresence' , Utilisateur) %}#}
                    {#                                        <a href="{{ path('TelechargerFeuillePresence', { 'id': Feuille.id }) }}">#}
                    {#                                            <i class="fas fa-download fa-lg" title="Télécharger la feuille"></i>#}
                    {#                                        </a>#}
                    {#                                    {% endif %}#}

                    {#                                </center>#}
                    {#                            </td>#}
                    {#                            </tr>#}
                    {#                            {% set Rapport = Feuille.rapportIntervention %}#}
                    {#                            #}{#                            {% for Rapport in Rapports %}#}
                    {#                            {% if (Rapport.FeuilleDePresence.id == Feuille.id) %}#}
                    {#                                {% if Rapport.confirmationDeInterventionParClient %}#}
                    {#                                    <tr class="row1" style="color: green; font-weight:bold">#}
                    {#                                {% else %}#}
                    {#                                    <tr class="row1">#}
                    {#                                {% endif %}#}
                    {#                                <td>#}
                    {#                                    {{ Rapport.FeuilleDePresence.dateIntervention|date('d-m-Y') }}#}
                    {#                                </td>#}
                    {#                                <td>#}
                    {#                                    {{ Rapport.FeuilleDePresence.client }}#}
                    {#                                </td>#}
                    {#                                <td>#}
                    {#                                    {{ Rapport.FeuilleDePresence.intervenant.nomUtilisateur }} {{ Rapport.FeuilleDePresence.intervenant.prenomUtilisateur }}#}
                    {#                                </td>#}
                    {#                                <td>#}
                    {#                                    Rapport d'intervention#}
                    {#                                </td>#}
                    {#                                <td>#}
                    {#                                    {% if Rapport.confirmationDeInterventionParClient %}#}
                    {#                                        Validé#}
                    {#                                    {% else %}#}
                    {#                                        Non Validé#}
                    {#                                    {% endif %}#}
                    {#                                </td>#}
                    {#                                <td>#}
                    {#                                    <center>#}
                    {#                                        {% if Rapport.confirmationDeInterventionParClient %}#}
                    {#                                            {% if AutorisationAcces('ConsulterRapportIntervention' , Utilisateur) %}#}
                    {#                                                <a href="{{ path('ConsulterRapportIntervention', { 'id': Rapport.id }) }}">#}
                    {#                                                    <i class="fas fa-search fa-lg"#}
                    {#                                                       title="Consulter le rapport d'intervention"></i>#}
                    {#                                                </a>#}
                    {#                                            {% endif %}#}
                    {#                                        {% endif %}#}
                    {#                                        {% if  not (Rapport.confirmationDeInterventionParClient) %}#}
                    {#                                            {% if AutorisationAcces('ModifierRapportIntervention' , Utilisateur) %}#}
                    {#                                                <a href="{{ path('ModifierRapportIntervention', { 'id': Rapport.id }) }}">#}
                    {#                                                    <i class="fas fa-edit fa-lg"#}
                    {#                                                       title="Modifier le rapport d'intervention"></i>#}
                    {#                                                </a>#}
                    {#                                            {% endif %}#}
                    {#                                            {% if AutorisationAcces('SupprimerUnRapport' , Utilisateur) %}#}
                    {#                                                <a href="{{ path('SupprimerUnRapport', { 'id': Rapport.id }) }}">#}
                    {#                                                    <i class="fas fa-trash fa-lg"#}
                    {#                                                       title="Supprimer le rapport d'intervention"></i>#}
                    {#                                                </a>#}
                    {#                                            {% endif %}#}
                    {#                                        {% else %}#}
                    {#                                            #}{#                                            <img src="{{ asset('Template/Editer.png') }}"#}
                    {#                                            #}{#                                                 title="Le rapport ne peut pas être modifié">#}
                    {#                                            #}{#                                            <img src="{{ asset('Template/SupprimerUser.png') }}"#}
                    {#                                            #}{#                                                 title="Le rapport ne peut pas être supprimé">#}
                    {#                                        {% endif %}#}
                    {#                                        {% if AutorisationAcces('TelechargerRapportIntervention' , Utilisateur) %}#}
                    {#                                            <a href="{{ path('TelechargerRapportIntervention', { 'id': Rapport.id }) }}">#}
                    {#                                                <i class="fas fa-download fa-lg" title="Télécharger le rapport"></i>#}
                    {#                                            </a>#}
                    {#                                        {% endif %}#}
                    {#                                    </center>#}
                    {#                                </td>#}
                    {#                                </tr>#}
                    {#                            {% endif %}#}
                    {#                            #}{#                            {% endfor %}#}
                    {#                        {% endfor %}#}
                    {#                    {% endif %}#}
                    {#                    </tbody>#}
                </table>
            </div>
        </div>
    </div>
    </div>
{% endblock %}
{% block css %}
    {{ parent() }}
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.3/css/responsive.dataTables.min.css"/>
    {#    <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/3.3.0/css/fixedColumns.dataTables.min.css"/>#}
    <link rel="stylesheet" type="text/css"
          href="https://cdn.datatables.net/v/dt/jszip-2.5.0/b-1.6.1/b-colvis-1.6.1/b-flash-1.6.1/b-html5-1.6.1/b-print-1.6.1/datatables.min.css"/>
    {#    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.css"/>#}
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.20/css/dataTables.bootstrap4.min.css"/>
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.6.1/css/buttons.bootstrap4.min.css"/>
    {#    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css">#}
    <link rel="stylesheet" href="https://cdn.datatables.net/searchpanes/1.1.1/css/searchPanes.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/select/1.3.1/css/select.dataTables.min.css">
    <style>
        #TableRIFP {
            font-size: 14px;
        }

        .green {
            color: green;
            font-weight: bold
        }

        div .dt-buttons {
            display: block;
            float: none;
            padding-bottom: 20px
        }

        .dataTables_length {
            display: block;
        }

        .buttons-excel {
            display: inline-block;
            margin: 0px;
            width: 15%;
        }

        div.dtsp-columns-3 {
            min-width: 0px;
        }

    </style>
{% endblock %}
{% block script %}
    {{ parent() }}
    <script src="https://cdn.datatables.net/fixedcolumns/3.3.0/js/dataTables.fixedColumns.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.2.3/js/dataTables.responsive.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script type="text/javascript"
            src="https://cdn.datatables.net/v/dt/jszip-2.5.0/b-1.6.1/b-colvis-1.6.1/b-flash-1.6.1/b-html5-1.6.1/b-print-1.6.1/datatables.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    {#    <script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.js"></script>#}
    {#    <script type="text/javascript" src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>#}
    <script type="text/javascript"
            src="https://cdn.datatables.net/searchpanes/1.1.1/js/dataTables.searchPanes.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/select/1.3.1/js/dataTables.select.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css"/>

    <script type="text/javascript">
        var startdate;
        var enddate;

        $.fn.dataTableExt.afnFiltering.push(
            function (oSettings, aData, iDataIndex) {
                if (typeof startdate === 'undefined' || typeof enddate === 'undefined') {
                    return true;
                }
                // console.log(aData);
                var coldate = moment(aData[3], 'DD-MM-YYYY');
                console.log('coldate', coldate);

                var valid = true;

                if (coldate.isValid()) {
                    if (enddate.isBefore(coldate)) {
                        console.log('enddate before coldate', enddate);
                        valid = false;
                    }

                    if (coldate.isBefore(startdate)) {
                        console.log('coldate before startdate', startdate);
                        valid = false;
                    }
                } else {
                    valid = false;
                }

                return valid;
            });
        $(document).ready(function () {
            // $("#select222").css('display', null);
            var data = {};
            {% if parClient is defined %}
            var x = '{{ parClient }}';
            if (x === 'parClient') {
                data.parClient = 'parClient';
            }
            {% endif %}
            var table = $('#TableRIFP').DataTable({
                language: {
                    processing: "Traitement en cours...",
                    search: "Rechercher&nbsp;:",
                    lengthMenu: "Afficher _MENU_ &eacute;l&eacute;ments",
                    info: "Affichage de l'&eacute;lement _START_ &agrave; _END_ sur _TOTAL_ &eacute;l&eacute;ments",
                    infoEmpty: "Affichage de l'&eacute;lement 0 &agrave; 0 sur 0 &eacute;l&eacute;ments",
                    infoFiltered: "(filtr&eacute; de _MAX_ &eacute;l&eacute;ments au total)",
                    infoPostFix: "",
                    loadingRecords: "Chargement en cours...",
                    zeroRecords: "Aucun &eacute;l&eacute;ment &agrave; afficher",
                    emptyTable: "Aucune donnée disponible dans le tableau",
                    paginate: {
                        first: "Premier",
                        previous: "Précédent",
                        next: "Suivant",
                        last: "Dernier"
                    },
                    aria: {
                        sortAscending: ": activer pour trier la colonne par ordre croissant",
                        sortDescending: ": activer pour trier la colonne par ordre décroissant"
                    },

                },
                // processing: true,
                // serverSide: true,
                ajax: {
                    url: "{{ path('feuillesJson') }}",
                    type: "GET",
                    dataSrc: '',
                    data: data
                },
                "columns": [
                    {"data": "id", "visible": false},
                    {"data": "Date"},
                    {"data": "Client"},
                    {"data": "Intervenant"},
                    {"data": "Type"},
                    {
                        "data": "Validation",
                        "render": function (data, type, row, meta) {
                            if (row.Validation == 'Validé') {
                                return '<span class="badge badge-success">' + row.Validation + '</span>';
                            } else {
                                return '<span class="badge badge-danger">' + row.Validation + '</span>';
                            }
                        }
                    },
                    {
                        data: null,
                        "searchable": false,
                        "orderable": false,
                        "render": function (data, type, row, meta) {

                            var htmltoAdd = '';
                            if (row.Type === 'Feuille de présence') {
                                {% if AutorisationAcces('ConsulterFeuillePresence' , app.user) %}
                                htmltoAdd = htmltoAdd + '<a class="btn btn-sm btn-default" href=' + Routing.generate('ConsulterFeuillePresence', {id: row.id}) + '><i class="fas fa-search fa-lg" title="Consulter la feuille de présence"></i> </a>';
                                {% endif %}
                                {% if AutorisationAcces('TelechargerFeuillePresence' , app.user) %}
                                htmltoAdd = htmltoAdd + '<a class="btn btn-sm btn-info" href=' + Routing.generate('TelechargerFeuillePresence', {id: row.id}) +
                                    '><i class="fas fa-download fa-lg" title="Télécharger la feuille"></i> </a>'
                                {% endif %}
                                if (row.Validation === 'Validé') {

                                    return htmltoAdd
                                } else {
                                    {% if AutorisationAcces('ModifierFeuillePresence' , app.user) %}
                                    htmltoAdd = htmltoAdd + '<a class="btn btn-sm btn-primary" href=' + Routing.generate('ModifierFeuillePresence', {id: row.id}) + '><i class="fas fa-edit fa-lg" title="Modifier la feuille de présnce"></i></a>';
                                    {% endif %}
                                    {% if AutorisationAcces('SupprimerUneFeuille' , app.user) %}
                                    htmltoAdd = htmltoAdd + ' <a class="btn btn-sm btn-danger" href=' + Routing.generate('SupprimerUneFeuille', {id: row.id}) + '  > <i class="fas fa-trash fa-lg" title="Supprimer la feuille de présence"></i> </a>'
                                    {% endif %}
                                    return htmltoAdd;
                                }

                            } else {
                                {% if AutorisationAcces('ConsulterRapportIntervention' , app.user) %}
                                htmltoAdd = htmltoAdd + '<a href=' + Routing.generate('ConsulterRapportIntervention', {id: row.id}) + '><i class="fas fa-search fa-lg" title="Consulter le rapport d&apos;intervention"></i></a>'
                                {% endif %}
                                {% if AutorisationAcces('TelechargerRapportIntervention' , app.user) %}
                                htmltoAdd = htmltoAdd + '<a href=' + Routing.generate('TelechargerRapportIntervention', {id: row.id}) + '><i class="fas fa-download fa-lg" title="Télécharger le rapport"></i> </a>'
                                {% endif %}
                                if (row.Validation === 'Validé') {

                                    return htmltoAdd;
                                } else {
                                    {% if AutorisationAcces('ModifierRapportIntervention' , app.user) %}
                                    htmltoAdd = htmltoAdd + '<a href=' + Routing.generate('ModifierRapportIntervention', {id: row.id}) + '><i class="fas fa-edit fa-lg" title="Modifier le rapport d&apos;intervention"></i> </a>'
                                    {% endif %}
                                    {% if AutorisationAcces('SupprimerUnRapport' , app.user) %}
                                    htmltoAdd = htmltoAdd + '<a class="btn btn-sm btn-danger" href=' + Routing.generate('SupprimerUnRapport', {id: row.id}) + '>\n' +
                                        '                                                                        <i class="fas fa-trash fa-lg"\n' +
                                        '                                                                           title="Supprimer le rapport d\'intervention"></i>\n' +
                                        '                                                                    </a>';
                                    {% endif %}

                                    return htmltoAdd;
                                }
                            }
                        }

                    }

                ],
                // "scrollX": true,
                "paging": true,
                "ordering": false,
                "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                dom: 'PBfrltip',
                searchPanes: {
                    panes: [
                        {
                            name: 'Validation',
                            header: 'Validation',
                            options: [
                                {
                                    label: 'Validé',
                                    value: function (rowData, rowIdx) {
                                        return rowData.Validation === 'Validé';
                                    }
                                },
                                {
                                    label: 'Non Validé',
                                    value: function (rowData, rowIdx) {
                                        return rowData.Validation === 'Non Validé';
                                    }
                                }
                            ]
                        }
                    ],
                },
                buttons: [
                    {
                        extend: 'excel',
                        text: '<i class="fas fa-file-export"></i> Exporter en excel',
                        className: "btn btn-success",
                        exportOptions: {
                            columns: [0, 1, 2, 3, 4],
                            rows: ':visible'
                        },
                        init: function (api, node, config) {
                            $(node).removeClass('dt-button')
                        },
                        customize: function (xlsx) {
                            var sheet = xlsx.xl.worksheets['sheet1.xml'];

                            $('c[r=A2] t', sheet).text('Date');
                            $('c[r=B2] t', sheet).text('Client');
                            $('c[r=C2] t', sheet).text('Intervenant');
                            $('c[r=D2] t', sheet).text('Type');
                            $('c[r=E2] t', sheet).text('Validation');
                        }
                    },
                ],
                columnDefs: [{
                    searchPanes: {
                        show: false,
                    },
                    targets: [0, 1, 6, 5],
                }],

                "createdRow": function (row, data, dataIndex) {
                    if (data.Validation == "Validé") {
                        $(row).addClass('green');

                    }
                }
            });


            {#if (x === 'parClient') {#}
            {#    $.ajax({#}
            {#        url: "{{ path('feuillesJson') }}",#}
            {#        type: "GET",#}
            {#        dataSrc: '',#}
            {#        data: 'parClient'#}

            {#    });#}
            // }
            $('.daterange').daterangepicker({
                "locale": {
                    "format": "MM/DD/YYYY",
                    "separator": " - ",
                    "applyLabel": "Appliquer",
                    "cancelLabel": "Annuler",
                    "fromLabel": "De",
                    "toLabel": "À",
                    "customRangeLabel": "Custom",
                    "daysOfWeek": [
                        "Di",
                        "Lu",
                        "Ma",
                        "Me",
                        "Je",
                        "Ve",
                        "Sa"
                    ],
                    "monthNames": [
                        "Janvier",
                        "Février",
                        "Mars",
                        "Avril",
                        "Mai",
                        "Juin",
                        "Juillet",
                        "Août",
                        "Septembre",
                        "Octobre",
                        "Novembre",
                        "Decembre"
                    ],
                    "firstDay": 1
                },
                // ranges: {
                //     "Today": [moment(), moment()],
                //     'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                //     '7 last days': [moment().subtract(6, 'days'), moment()],
                //     '30 last days': [moment().subtract(29, 'days'), moment()],
                //     'This month': [moment().startOf('month'), moment().endOf('month')],
                //     'Last month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
                //     'Blank date': [moment("01-01-0001"), moment("01-01-0001")]
                // },
                autoUpdateInput: false,
                opens: "left",
                // locale: {
                //     cancelLabel: 'Clear',
                //     format: 'DD-MM-YYYY'
                // }
            });
            var startDate;
            var endDate;
            var dataIdx = 1;
            //current data column to work with
            // $("#mytable_wrapper thead").on("mousedown", "th", function (event) {
            //     var visIdx = $(this).parent().children().index($(this));
            //     dataIdx = table.column.index('fromVisible', visIdx);
            // });
            // Function for converting a dd/mmm/yyyy date value into a numeric string for comparison (example 01-Dec-2010 becomes 20101201
            function parseDateValue(rawDate) {

                var d = moment(rawDate, "DD-MM-YYYY").format('DD-MM-YYYY');
                var dateArray = d.split("-");
                var parsedDate = dateArray[2] + dateArray[1] + dateArray[0];
                return parsedDate;
            }

            //filter on daterange
            $(".daterange").on('apply.daterangepicker', function (ev, picker) {
                ev.preventDefault();
                //if blank date option was selected
                if ((picker.startDate.format('DD-MM-YYYY') == "01-01-0001") && (picker.endDate.format('DD-MM-YYYY')) == "01-01-0001") {
                    $(this).val('Blank');


                    val = "^$";

                    table.column(dataIdx)
                        .search(val, true, false, true)
                        .draw();

                } else {
                    //set field value
                    $(this).val(picker.startDate.format('DD-MM-YYYY') + ' à ' + picker.endDate.format('DD-MM-YYYY'));

                    //run date filter
                    startDate = picker.startDate.format('DD-MM-YYYY');
                    endDate = picker.endDate.format('DD-MM-YYYY');

                    var dateStart = parseDateValue(startDate);
                    var dateEnd = parseDateValue(endDate);
                    console.log(dateStart);
                    console.log(dateEnd);
                    console.log(dataIdx);
                    var filteredData = table
                        .column(dataIdx)
                        .data()
                        .filter(function (value, index) {

                            var evalDate = value === "" ? 0 : parseDateValue(value);
                            if ((isNaN(dateStart) && isNaN(dateEnd)) || (evalDate >= dateStart && evalDate <= dateEnd)) {

                                return true;
                            }
                            return false;
                        });


                    var val = "";
                    for (var count = 0; count < filteredData.length; count++) {

                        val += filteredData[count] + "|";
                    }

                    val = val.slice(0, -1);


                    table.column(dataIdx)
                        .search(val ? "^" + val + "$" : "^" + "-" + "$", true, false, true)
                        .draw();
                }


            });


            $(".daterange").on('cancel.daterangepicker', function (ev, picker) {
                ev.preventDefault();
                $(this).val('');
                table.column(dataIdx)
                    .search("")
                    .draw();
            });
        })
        ;
    </script>
{% endblock %}
